<html>

<head>
	<title>Game</title>
	<link rel="stylesheet" href="styles/game.css">
	<link rel="stylesheet" href="styles/pantallaJ.css">
	<link rel="stylesheet" href="styles/stylePausa.css">
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
		integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
	<!-- CSS only -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
	<!-- JavaScript Bundle with Popper -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0"
		crossorigin="anonymous"></script>
	<script type="text/javascript" src="js/jquery/jquery-2.1.4.min.js"></script>
	<script type="text/javascript" src="js/three/three.js"></script>
	<script type="text/javascript" src="js/three/MTLLoader.js"></script>
	<script type="text/javascript" src="js/three/OBJLoader.js"></script>
	<script type="text/javascript" src="js/escenarios/nivel1/nivel1.js"></script>
	<script type="text/javascript" src="js/escenarios/nivel1/nivel1Anim.js"></script>
	<script type="text/javascript" src="js/escenarios/nivel2/nivel2.js"></script>
	<script type="text/javascript" src="js/escenarios/nivel2/nivel2Anim.js"></script>
	<script type="text/javascript" src="js/escenarios/nivel3/nivel3.js"></script>
	<script type="text/javascript" src="js/escenarios/nivel3/nivel3Anim.js"></script>


	<script type="text/javascript">
		var scene;
		var camera;
		var renderer;
		var controls;
		var objects = [];
		var clock;
		var deltaTime;
		var keys = {};
		var keysQueue = [], keysQueue2 = [];
		var jugador1 = [];
		var jugador2 = [];
		var vagones1 = [];
		var vagones2 = [];

		var lastPosition1 = [];
		var lastPosition2 = [];

		var queNivel = 2;
		var anim = [];
		var anim2 = [];
		var anim3 = [];
		var anim4 = [];
		var anim5 = [];
		var anim6 = [];
		var anim7 = [];
		var anim8 = [];

		var direction = new THREE.Vector3(0, 0, 1);
		var direction2 = new THREE.Vector3(0, 0, 1);
		var direction3 = new THREE.Vector3(0,0,1);
		var arriba = false, derecha = false;
		var integer = [50], integer2 = 0;
		var integer3 = 0, integer4 = 0;
		var laMoneda = [];
		var edgeSize = 50, padding = 0.15;

		var pause;
		var raycaster;
		var objetosConColision = [];
		var hola = [];

		var nivel2Contador = 0;
		var nivel2Contador2 = 0;
		var nivel3Contador = 0;



		function randInRange(a, b) {
			return a + Math.floor((b - a) * Math.random());
		}
		function spawnAppleVector() {
			var x = randInRange(-48, 48), z = randInRange(-48, 48);
			return new THREE.Vector3(x, 1, z);
		}

		$(document).ready(function () {
			setupScene();
			// rayos para las colisiones


			// la moneda
			var monedaPosi = spawnAppleVector();
			loadOBJWithMTL("assets/obj/", "coin3.obj", "coin3.mtl", (moneda) => {

				console.log("x: " + monedaPosi.x + " Z: " + monedaPosi.z);


				laMoneda.push(moneda);
				transform(laMoneda[0], monedaPosi.x, 1.5, monedaPosi.z, 90, 0, 0, 1.5);
				scene.add(moneda);


			});

			//document.addEventListener('keydown', onKeyDown);
			//document.addEventListener('keyup', onKeyUp);
			gamepause(false);

			render();
		});

		function loadOBJWithMTL(path, objFile, mtlFile, onLoadCallback) {
			var mtlLoader = new THREE.MTLLoader();
			mtlLoader.setPath(path);
			mtlLoader.load(mtlFile, (materiales) => {
				var objLoader = new THREE.OBJLoader();
				objLoader.setPath(path);
				objLoader.setMaterials(materiales);
				objLoader.load(objFile, (objCargado) => {
					onLoadCallback(objCargado);
				});
			});
		}

		function gamepause(aux) {
			pause = aux;
		}

		function onKeyDown(event) {
			keys[String.fromCharCode(event.keyCode)] = true;
		}
		function onKeyUp(event) {
			keys[String.fromCharCode(event.keyCode)] = false;
		}


		document.addEventListener("keydown", function (e) {
			switch (e.key) {

				case "ArrowDown":
					keysQueue.push(new THREE.Vector3(0, 0, 1));
					break;
				case "ArrowUp":
					keysQueue.push(new THREE.Vector3(0, 0, 1));
					break;
				case "ArrowLeft":
					keysQueue.push(new THREE.Vector3(0, 0, 1));
					integer[0] = 1;
					break;
				case "ArrowRight":
					keysQueue.push(new THREE.Vector3(0, 0, 1));
					integer[1] = 1;
					break;



				case "s":
					keysQueue2.push(new THREE.Vector3(0, 0, 1));
					break;
				case "w":
					keysQueue2.push(new THREE.Vector3(0, 0, 1));
					break;
				case "a":
					keysQueue2.push(new THREE.Vector3(0, 0, 1));
					integer[2] = 1;
					break;
				case "d":
					keysQueue2.push(new THREE.Vector3(0, 0, 1));
					integer[3] = 1;
					break;



				case "x":

					integer[4] = 1;
					break;
			}
		});

		function render() {
			requestAnimationFrame(render);
			deltaTime = clock.getDelta();
			var velocidad = 20;

			//tren inicial derecha
			direction = keysQueue.length > 0 ? keysQueue.pop(0) : direction;
			//tren inicial izquierda
			direction2 = keysQueue2.length > 0 ? keysQueue2.pop(0) : direction2;

			jugador2[0].translateX(direction2.x * deltaTime * velocidad);
			jugador2[0].translateZ(direction2.z * deltaTime * velocidad);

			jugador1[0].translateX(direction.x * deltaTime * velocidad);
			jugador1[0].translateZ(direction.z * deltaTime * velocidad);

			// Seguimiento de vagones:
			var pos1 = new THREE.Vector3(jugador1[0].position.x, 0, jugador1[0].position.z);

			lastPosition1.push(pos1);

			console.log("X: "+ jugador1[0].position.x + " y: "+ jugador1[0].position.z);


			for (let i = 1; i < vagones1.length; i++) {

				var ultiPosi = lastPosition1[lastPosition1.length -15-i*7];
				transform(vagones1[i], ultiPosi.x, 0, ultiPosi.z, 0, 0, 0, 1);
				//vagones1[i].translateX(ultiPosi.x);
				//vagones1[i].translateZ(ultiPosi.z);

				


			}









			// Animaciones:
			laMoneda[0].rotateZ(deltaTime);

			////////////////////////////////Animacion del nivel////////////////////////////////////////////
			if(queNivel == 1){
				nivel1Anim();
			}
			else if(queNivel == 2){
				nivel2Anim();
			}
			else if(queNivel == 3){
				nivel3Anim();
			}
			//////////////////////////////////////////////////////////////////////////////////////////////////


			// Esto pasa cuando toca las teclas:

			if (integer[0] == 1) {
				jugador1[0].rotateY(THREE.Math.degToRad(90));
				integer[0] = 0;
			}
			if (integer[1] == 1) {
				jugador1[0].rotateY(THREE.Math.degToRad(-90));
				integer[1] = 0;

			}
			if (integer[2] == 1) {
				jugador2[0].rotateY(THREE.Math.degToRad(90));
				integer[2] = 0;

			}
			if (integer[3] == 1) {
				jugador2[0].rotateY(THREE.Math.degToRad(-90));
				integer[3] = 0;

			}
			if (integer[4] == 1) {
				//monedas posicion
				var monedaPosi = spawnAppleVector();
				transform(laMoneda[0], monedaPosi.x, 1.5, monedaPosi.z, 90, 0, 0, 1.5);
				integer[4] = 0;
			}


			// si colisiona con la moneda
			if (jugador1[0].position.distanceTo(laMoneda[0].position) < 3) {
				// nueva posición de la moneda
				var monedaPosi = spawnAppleVector();
				transform(laMoneda[0], monedaPosi.x, 1.5, monedaPosi.z, 90, 0, 0, 1.5);

				// nuevo vagón detrás
				var nuevoVagon = vagones1[0].clone();
				transform(nuevoVagon, jugador1[0].position.x, 0, jugador1[0].position.z, 0, 0, 0, 1);
				vagones1.push(nuevoVagon);
				scene.add(vagones1[vagones1.length - 1]);

				console.log("Si hay colision moneda vagon derecho");
			} else if (jugador2[0].position.distanceTo(laMoneda[0].position) < 3) {
				// nueva posición de la moneda
				var monedaPosi = spawnAppleVector();
				transform(laMoneda[0], monedaPosi.x, 1.5, monedaPosi.z, 90, 0, 0, 1.5);

				// nuevo vagón detrás
				console.log("Si hay colision moneda vagon izqu");
			}

			/* 
			jugadores[1].translateZ(-(velocidad * deltaTime));
			
			
			*/

			renderer.render(scene, camera);

		}

		function setupScene() {
			var visibleSize = { width: window.innerWidth, height: window.innerHeight };
			clock = new THREE.Clock();
			scene = new THREE.Scene();
			camera = new THREE.PerspectiveCamera(75, visibleSize.width / visibleSize.height, 0.1, 100);
			//camera.position.z = 2;
			camera.position.y = 80;
			camera.rotation.x = THREE.Math.degToRad(-90);

			renderer = new THREE.WebGLRenderer({ precision: "mediump" });
			renderer.setClearColor(new THREE.Color(0, 0, 0));
			renderer.setPixelRatio(visibleSize.width / visibleSize.height);
			renderer.setSize(visibleSize.width, visibleSize.height);

			var ambientLight;

			if(queNivel == 1){
				ambientLight = new THREE.AmbientLight(new THREE.Color(1, 1, 1), 1.0);
			}
			else if(queNivel == 2){
				ambientLight = new THREE.AmbientLight(new THREE.Color(0.9, 0.9, 1), 1.0);
			}
			else if(queNivel == 3){
				ambientLight = new THREE.AmbientLight(new THREE.Color(1, 1, 1), 1.0);
			}
			scene.add(ambientLight);

			var directionalLight = new THREE.DirectionalLight(new THREE.Color(1, 1, 0), 0.4);
			directionalLight.position.set(0, 0, 1);
			directionalLight.castShadow = true;
			scene.add(directionalLight);

			var grid = new THREE.GridHelper(50, 10, 0xffffff, 0xffffff);
			grid.position.y = 1;
			scene.add(grid);

			loadOBJWithMTL("assets/obj/", "SM_Veh_Metro_01.obj", "main.mtl", (jugador) => {//izquierda
				transform(jugador, -30, 0, 0, 0, 0, 0, 1);
				scene.add(jugador);
				jugador2.push(jugador);
			});
			loadOBJWithMTL("assets/obj/", "SM_Veh_Metro_01.obj", "main.mtl", (jugador) => {//derecha
				transform(jugador, 30, 0, 0, 0, 0, 0, 1);
				scene.add(jugador);
				jugador1.push(jugador);
			});

			// carga de vagones cuadrados 

			loadOBJWithMTL("assets/obj/", "vagon02.obj", "vagon02.mtl", (vagon) => {//izquierda
				transform(vagon, 0, 0, 70, 90, 0, 0, 1);
				scene.add(vagon);
				vagones1.push(vagon);
			});

			loadOBJWithMTL("assets/obj/", "vagon02.obj", "vagon02.mtl", (vagon) => {//izquierda
				transform(vagon, 0, 0, 70, 0, 0, 0, 1);
				scene.add(vagon);
				vagones2.push(vagon);
			});

			////////////////////////////////CARGA DE ESCENARIOS/////////////////////////////////////////
			if(queNivel == 1){
				nivel1();
			}
			else if(queNivel == 2){
				nivel2();
			}
			else if(queNivel == 3){
				nivel3();
			}
			else{
				alert ("No ha seleccionado ningun nivel.")
			}
			///////////////////////////////////////////////////////////////////////////////////////////


			$("#scene-section").append(renderer.domElement);
		}

		function transform(model, posX, posY, posZ, rotX, rotY, rotZ, esc) {
			model.position.x = posX;
			model.position.y = posY;
			model.position.z = posZ;
			model.rotation.set(THREE.Math.degToRad(rotX), THREE.Math.degToRad(rotY), THREE.Math.degToRad(rotZ));
			model.scale.set(0.3 * esc, 0.3 * esc, 0.3 * esc);
		}


	</script>
</head>

<body>

	<div id="scene-section">
		<div class="boton-pausa">
			<button type="hidden" class="pause" data-bs-toggle="modal" data-bs-target="#modalPausa">
				<span class="material-icons md-xx md-light" :hover>
					pause
				</span>
			</button>
		</div>
		<!-- IMAGENES DE LOS JUGADPRES-->
		<div class="JugadoreLeft">
			<img class="image-fit profileLeft"
				src="https://cdn0.iconfinder.com/data/icons/set-ui-app-android/32/8-512.png" alt="no se cargo :(">
			<label class="JugadoreLeftName">Diego</label>
		</div>
		<div class="JugadorRight">
			<img class="image-fit profileRight"
				src="https://cdn0.iconfinder.com/data/icons/set-ui-app-android/32/8-512.png" alt="no se cargo :(">
			<label class="JugadorRightName">Gonzalo</label>
		</div>
	</div>
	<div class="modal fade" id="modalPausa" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<img id="juegoEnPausa" src="images/rail_road_paused.png" alt="PAUSE">
				</div>
				<div class="animacion_pausa">
					<img class="tren_pausa" src="images/tren1.png" alt="tren">
					<img class="rails_road" src="images/rails_road.png" alt="rails_road">
					<img class="rails_road" src="images/rails_road.png" alt="rails_road">
					<img class="rails_road" src="images/rails_road.png" alt="rails_road">
					<img class="rails_road" src="images/rails_road.png" alt="rails_road">
					<img class="rails_road" src="images/rails_road.png" alt="rails_road">
				</div>
				<br>
				<div class="elFooter">
					<button id="btnResume" type="button" class="btn btn-primary" data-bs-dismiss="modal">Resume</button>
					<a href="principal.html">

						<button id="btnQuit" type="button" class="btn btn-primary">Quit</button>
					</a>
					<br><br>
				</div>
			</div>
		</div>
	</div>

	<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
		integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
		crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
		integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
		crossorigin="anonymous"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
		integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
		crossorigin="anonymous"></script>
</body>

</html>